<!-- This example uses hangoutiframer.  See
     http://hangoutiframer.appspot.com for further details. -->

<!-- Standard boilerplate to start hangouts.  Without these, your Hangout will not start. -->
<script src="//hangoutsapi.talkgadget.google.com/talkgadget/apps/gadgets/js/rpc.js"></script>
<script src="//plus.google.com/hangouts/_/api/v1/hangout.js"></script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>

<body style="padding: 10px; background-color: white;">

<h3>HangIn: Always on hangout for teams</h3>

<div id="stepoutControls">
  <button id="stepout">Jump Out</button>
  <button id="stepin" style="display: none;">Jump In</button>
</div>

<hr>

<div id="faceStatus"></div>

<video id="video"></video>

<canvas id="snapshot"></canvas>
<canvas id="avatarcanvas" style="display:none"></canvas>

<script>

// UI controls
var stepout = $('#stepout');
var stepin = $('#stepin');


/* Background Replacement */

// resources
var backgroundImageUrl = 'http://www.gstatic.com/chat/apps/fx/v1.12/fx/config/backgrounds/mosaic.png';
var backgroundImage = gapi.hangout.av.effects.createImageResource(backgroundImageUrl);
var backgroundReplacement = null;

var snapshotTimer = 0;
function takeSnapshot() {
		// Get handles on the video and canvas elements
    //var video = gapi.hangout.layout.getVideoCanvas();
    var video = document.querySelector("video");
    var canvas = document.querySelector('#snapshot');
    // Get a handle on the 2d context of the canvas element
    var context = canvas.getContext('2d');
    // Define some vars required later
    var w, h, ratio;
    var streaming = false;
    var width = 200;
    var height = 0;


    // create our own video stream
      navigator.getMedia = ( navigator.getUserMedia ||
                             navigator.webkitGetUserMedia ||
                             navigator.mozGetUserMedia ||
                             navigator.msGetUserMedia);

      navigator.getMedia(
        {
          video: true,
          audio: false
        },
        function(stream) {
          if (navigator.mozGetUserMedia) {
            video.mozSrcObject = stream;
          } else {
            var vendorURL = window.URL || window.webkitURL;
            video.src = vendorURL.createObjectURL(stream);
          }
          video.play();
        },
        function(err) {
          console.log("An error occured! " + err);
        }
      );

      video.addEventListener('canplay', function(ev){
        if (!streaming) {
          height = video.videoHeight / (video.videoWidth/width);
          video.setAttribute('width', width);
          video.setAttribute('height', height);
          canvas.setAttribute('width', width);
          canvas.setAttribute('height', height);
          streaming = true;
        }
        doSnapshot();
      }, false);


    function doSnapshot() {
        $(video).hide();
        $(canvas).hide();
        context.fillRect(0, 0, width, height);
        // Grab the image from the video
        context.globalAlpha = 0.75;
        context.drawImage(video, 0, 0, width, height);
        // need to send to everyone else
        var image = canvas.toDataURL("image/png");
        gapi.hangout.av.setAvatar(
            gapi.hangout.getLocalParticipantId(),
            image
        );
        //gapi.hangout.data.sendMessage(image);
        $(video).hide();
        $(canvas).hide();
    }
    snapshotTimer = window.setInterval(function(){
        if (streaming) {
            doSnapshot();
        }
    }, 10000);
}

var status_urls = {}
var avatar_urls = {}

function showAvatarStatus(pid, status) {
    if (gapi.hangout.av.isParticipantVisible(pid)){
        return
    }

    if (status_urls[pid] && status_urls[pid][status]) {
        return status_urls[pid][status];
    }

    var canvas = document.getElementById("avatarcanvas");
    var context = canvas.getContext("2d");

    var url;
    if (avatar_urls[pid]) {
        url = avatar_urls[pid];
    } else {
        url = gapi.hangout.av.getAvatar(pid);
    }
    if (!url) {
        url = "https://lh3.googleusercontent.com/-8alR-lCxhLE/AAAAAAAAAAI/AAAAAAAAAAA/le7tT6BEJ44/s177-c/photo.jpg";
    }
    avatar_urls[pid] = url;

    if (status) {
        new_url = url;
    }
    else {
        // greyed out
        new_url = "http://dub.washington.edu/static/imgs/default-profile-pic.png";
    }
    gapi.hangout.av.setAvatar(pid, new_url);
    return;

    var img = new Image();
    img.src = url;
    img.onload = function() {
        context.drawImage(img, 145, 145);
        canvas.setAttribute('width', img.width);
        canvas.setAttribute('height', img.height);
        //draw circle on top
        context.fillStyle = "rgba(93,179,199,0.20)";
        context.beginPath();
        context.arc(225,225,115,0,Math.PI*2,true);
        context.closePath();
        context.fill();
        var new_url = canvas.toDataURL("image/png");
        gapi.hangout.av.setAvatar(pid, new_url);
        status_urls[pid][status] = new_url;
    };


}

function setShowUser(pid, show) {
    gapi.hangout.av.setParticipantAudible(pid, show);
    gapi.hangout.av.setParticipantVisible(pid, show);
}

function doStepOut() {
    //set shared state so others can hide me
    // will also hide myself
    var myid = gapi.hangout.getLocalParticipantId();
    gapi.hangout.data.setValue(myid, "1");

    // I also don't want to hear or see anybody

    //gapi.hangout.getEnabledParticipants(); // running the app
    var all = gapi.hangout.getParticipants();
    for (var i=0; i<all.length; i++) {
        var p = all[i];
        showUser(p.id, false);
    }
    //gapi.hangout.av.setMicrophoneMute(true);
    showUser(myid, false);
    // show ourselfs as others will see us
    showAvatarStatus(myid, 0);

    stepin.show();
    stepout.hide();
    //takeSnapshot()


}


function doStepIn() {
    window.clearInterval(snapshotTimer);

    var myid = gapi.hangout.getLocalParticipantId();

    //set shared state so others can show me again
    // will also show myself
    gapi.hangout.data.clearValue(myid);

    //gapi.hangout.getEnabledParticipants(); // running the app

    // Let me see and hear everyone also stepped in. ie exclude those who stepped out
    var all = gapi.hangout.getParticipants();
    for (var i=0; i<all.length; i++) {
        var p = all[i];
        if (gapi.hangout.data.getValue(p.id)){
            continue;
        }
        //else
        showUser(p.id, true);
        gapi.hangout.av.clearAvatar(p.id);
    }
    //gapi.hangout.av.setCameraMute(false);
    gapi.hangout.av.setMicrophoneMute(false);
    showUser(myid, true);

    // get rid of your snapshot
    gapi.hangout.av.clearAvatar(myid);

    stepout.show();
    stepin.hide();


}

function stateChanged(ev) {
    for (var i=0; i<ev.addedKeys.length; i++) {
        var pid = ev.addedKeys[i].key;
        // user stepped out. mute them
        showUser(pid, false);
        // Assume they are away until we get messages
        showAvatarStatus(pid, 0);
    }
    for (var i=0; i<ev.removedKeys.length; i++) {
        var pid = ev.removedKeys[i];
        // user stepped in. unmute them
        showUser(pid, true);
        gapi.hangout.av.clearAvatar(pid);
    }
}

/*
 * Received away status
 */
function messageReceived(ev) {
    // updates on where user is looking
    var sender = ev.senderId;
    var image = ev.message;
    if (image=='away') {
        // they stepped out
        showAvatarStatus(sender, 0);

    } else if (image='looking') {
        showAvatarStatus(sender, 1);
    }
}

var total_away = 0;
var total_here = 0;

/*
 * Collect data about face to determine away status
 */
function faceChanged(data) {
    // we need to send messages anytime someone is stepped in
    // TODO: don't send if there is no one out

    if (data.hasFace) {
        $("#faceStatus").text("Looking");
        total_here += 1;
    } else {
        $("#faceStatus").text("away");
        total_away += 1;
    }
}

/*
 * Periodically determine aways status and send
 */
function sendAwayStatus() {
    var avg_here = total_here/(total_away+total_here);
    total_here = 0;
    total_away = 0;

    if (avg_here >= 0.3) {
        gapi.hangout.data.sendMessage("looking");
        showAvatarStatus(gapi.hangout.getLocalParticipantId(), 1);
    } else {
        gapi.hangout.data.sendMessage("away");
        showAvatarStatus(gapi.hangout.getLocalParticipantId(), 0);
    }

}

// Kicks off app and attaches all listeners.
function startApp() {


    // add behavior to UI Controls
    stepout.click(doStepOut);
    stepin.click(doStepIn);

    gapi.hangout.data.onMessageReceived.add(messageReceived);
    gapi.hangout.data.onStateChanged.add(stateChanged);
    gapi.hangout.av.effects.onFaceTrackingDataChanged.add(faceChanged);
//    gapi.hangout.onEnabledParticipantsChanged.add( function(ev) {
//        for (var i=0; i<ev.enabledParticipants.length; i++) {
//            var pid = ev.enabledParticipants[i];
//            stepIn(pid);
//        }
//    })
    window.setInterval(sendAwayStatus, 5000);

    doStepIn();
}


function init() {
  gapi.hangout.onApiReady.add(
      function(eventObj) {
        startApp();
      });
}

// Add API listener immediately.  If you need an
// OAuth 2.0 access token, your startup will need to
// be different.
init();
</script>
